<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üè¶ Chase Statement Parser</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 1.5rem;
      max-width: 900px;
      margin: 0 auto;
      background-color: #fafafa;
      color: #333;
    }
    h1 { color: #1a5fb4; margin-bottom: 0.5rem; }
    .subtitle { color: #666; margin-top: 0; }
    input[type="file"] {
      margin: 1rem 0;
      font-size: 1rem;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      width: 100%;
      box-sizing: border-box;
    }
    progress {
      margin-top: 0.5rem;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      display: none;
    }
    .log {
      font-size: 0.85rem;
      color: #555;
      margin: 0.5rem 0;
      min-height: 1.2em;
    }
    #output {
      margin-top: 1.5rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }
    th, td {
      padding: 12px 14px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #1a5fb4;
    }
    tr.expense td:first-child { color: #d32f2f; }
    tr.income td:first-child { color: #2e7d32; }
    .summary {
      background: #f0f7ff;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1.5rem;
    }
    .summary h3 { margin-top: 0; color: #1a5fb4; }
    .summary p { margin: 0.3rem 0; }
    .btn {
      background: #1a5fb4;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 1rem;
    }
    .btn:hover { background: #144d96; }
    .debug-toggle {
      color: #1a73e8;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .debug {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 6px;
      margin-top: 1rem;
      white-space: pre-wrap;
      max-height: 200px;
      overflow: auto;
      font-family: monospace;
      font-size: 0.85rem;
    }
    footer {
      margin-top: 2rem;
      font-size: 0.8rem;
      color: #888;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>üè¶ Chase Statement Parser</h1>
  <p class="subtitle">Upload your Chase PDF statement ‚Äî we‚Äôll extract transactions instantly.</p>

  <input type="file" id="pdfUpload" accept=".pdf" />
  <progress id="progress" value="0" max="100"></progress>
  <div id="log" class="log">üëâ Choose a PDF to begin.</div>
  
  <div id="output"></div>

  <footer>
    <p>All processing happens in your browser ‚Äî no data is sent anywhere.</p>
  </footer>

  <script>
    // ‚úÖ FINAL Chase Parser ‚Äî handles multi-space, line breaks, and "Purchase"/"Transfer"
    function parseChaseStatement(text) {
      // Step 1: Normalize whitespace & force line breaks before dates
      let cleaned = text
        .replace(/\s+/g, ' ') // collapse all whitespace ‚Üí single space
        .replace(/(\d{1,2} [A-Za-z]{3} \d{4})/g, '\n$1') // split before each date
        .trim();

      const lines = cleaned.split('\n').map(l => l.trim()).filter(l => l.length > 25);

      const monthMap = {
        Jan: '01', Feb: '02', Mar: '03', Apr: '04', May: '05', Jun: '06',
        Jul: '07', Aug: '08', Sep: '09', Oct: '10', Nov: '11', Dec: '12'
      };

      const transactions = [];
      // üîë Key fix: explicitly match "Purchase", "Transfer", etc. as separate word
      const transactionRegex = /(\d{1,2})\s+([A-Za-z]{3})\s+(\d{4})\s+(.*?)\s+(Purchase|Transfer|Refund|Payment)\s+([+-]¬£[\d,]*\.?\d+)\s+¬£[\d,]*\.?\d+/;

      for (const line of lines) {
        // Skip known non-transaction lines
        if (
          line.includes('Account number') ||
          line.includes('Sort code') ||
          line.includes('Thomas\' Account statement') ||
          line.includes('Opening balance') ||
          line.includes('Closing balance') ||
          line.includes('Page ') ||
          line.includes('FSCS') ||
          line.includes('From 1 December 2025') ||
          line.includes('The best way to call')
        ) continue;

        const match = line.match(transactionRegex);
        if (match) {
          const [_, day, monthAbbr, year, brand, typeWord, amountStr] = match;

          const month = monthMap[monthAbbr] || '01';
          const date = `${year}-${month}-${day.padStart(2, '0')}`;

          // Parse amount: strip ¬£, commas, handle sign
          let amountNum = parseFloat(amountStr.replace(/[¬£,+]/g, ''));
          if (amountStr.includes('-')) amountNum = -amountNum;

          // Clean brand: e.g., "Box.co.uk - Klarna" ‚Üí "Klarna"
          let description = brand.trim();
          if (description.includes(' - ')) {
            const parts = description.split(' - ');
            description = parts[parts.length - 1].trim();
          }

          transactions.push({
            date,
            description,
            amount: Math.abs(amountNum),
            type: amountNum < 0 ? 'expense' : 'income'
          });
        }
      }

      return transactions;
    }

    // üì• PDF Upload Handler
    document.getElementById('pdfUpload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const output = document.getElementById('output');
      const log = document.getElementById('log');
      const progress = document.getElementById('progress');

      output.innerHTML = '';
      log.textContent = `‚úÖ File selected: ${file.name}`;
      progress.style.display = 'block';
      progress.value = 10;

      if (!file.name.toLowerCase().endsWith('.pdf')) {
        log.textContent = '‚ö†Ô∏è Please upload a .pdf file.';
        progress.style.display = 'none';
        return;
      }

      log.textContent = 'üì¶ Reading file...';

      try {
        const reader = new FileReader();
        reader.onload = async function() {
          const typedarray = new Uint8Array(reader.result);

          log.textContent = 'üì• Loading pdf.js (one-time, ~500 KB)...';
          const pdfjs = await import('https://unpkg.com/pdfjs-dist@4.4.168/build/pdf.min.mjs');
          pdfjs.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@4.4.168/build/pdf.worker.min.mjs';

          log.textContent = 'üìÑ Parsing PDF pages...';
          progress.value = 30;

          const loadingTask = pdfjs.getDocument(typedarray);
          loadingTask.onProgress = ({ loaded, total }) => {
            progress.value = 30 + (loaded / total) * 60;
          };

          const pdf = await loadingTask.promise;
          log.textContent = `‚úÖ Loaded ${pdf.numPages} page(s). Extracting text...`;

          let fullText = '';
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join(' ');
            fullText += pageText + ' ';
          }

          log.textContent = 'üîç Parsing Chase transactions...';
          const transactions = parseChaseStatement(fullText);

          if (transactions.length === 0) {
            // Show debug info for troubleshooting
            const snippet = fullText.substring(0, 800).replace(/\n/g, ' ‚Üµ ');
            output.innerHTML = `
              <div style="padding:1.5rem; background:#fff9f9; border-left:4px solid #d32f2f;">
                <h3>‚ö†Ô∏è No transactions found</h3>
                <p>We tried to parse your Chase statement, but couldn‚Äôt match any lines.</p>
                <p><strong>Try:</strong> Exporting a fresh statement from the Chase app (PDF, not image).</p>
                <p class="debug-toggle" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                  üîç Show first 800 chars (click to toggle)
                </p>
                <div class="debug" style="display:none;">${snippet}</div>
              </div>
            `;
          } else {
            const expenses = transactions.filter(t => t.type === 'expense');
            const income = transactions.filter(t => t.type === 'income');

            const totalExpenses = expenses.reduce((sum, t) => sum + t.amount, 0);
            const totalIncome = income.reduce((sum, t) => sum + t.amount, 0);
            const net = totalIncome - totalExpenses;

            let rows = '';
            transactions.forEach(t => {
              const cls = t.type === 'expense' ? 'expense' : 'income';
              const sign = t.type === 'expense' ? '‚àí' : '+';
              rows += `
                <tr class="${cls}">
                  <td>${t.date}</td>
                  <td>${t.description}</td>
                  <td>${sign}¬£${t.amount.toFixed(2)}</td>
                </tr>
              `;
            });

            const summary = `
              <div class="summary">
                <h3>üìä Summary</h3>
                <p><strong>Expenses:</strong> ‚àí¬£${totalExpenses.toFixed(2)}</p>
                <p><strong>Income:</strong> +¬£${totalIncome.toFixed(2)}</p>
                <p><strong>Net change:</strong> <span style="color:${net >= 0 ? '#2e7d32' : '#d32f2f'}">${net >= 0 ? '+' : ''}¬£${net.toFixed(2)}</span></p>
                <p><strong>Total transactions:</strong> ${transactions.length}</p>
              </div>
            `;

            const table = `
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Amount</th>
                  </tr>
                </thead>
                <tbody>
                  ${rows}
                </tbody>
              </table>
            `;

            output.innerHTML = summary + table + `
              <button class="btn" onclick="downloadCSV(${JSON.stringify(transactions).replace(/'/g, "\\'")})">
                ‚¨áÔ∏è Download Transactions as CSV
              </button>
            `;
          }

          progress.style.display = 'none';
          log.textContent = `üéâ Done! ${transactions.length} transactions extracted.`;
        };

        reader.onerror = () => {
          log.textContent = '‚ùå Failed to read file.';
          progress.style.display = 'none';
        };

        reader.readAsArrayBuffer(file);
      } catch (error) {
        log.textContent = `üí• Error: ${error.message}`;
        output.innerHTML = `<pre style="padding:1rem; background:#ffebee; color:#c62828;">${error.stack || error}</pre>`;
        progress.style.display = 'none';
        console.error(error);
      }
    });

    // üì• CSV Download
    window.downloadCSV = function(transactions) {
      const header = 'Date,Description,Amount,Type\n';
      const rows = transactions.map(t => 
        `"${t.date}","${t.description.replace(/"/g, '""')}","${t.amount}","${t.type}"`
      ).join('\n');
      const csvContent = 'text/csv;charset=utf-8,' + encodeURIComponent(header + rows);
      
      const link = document.createElement('a');
      link.setAttribute('href', csvContent);
      link.setAttribute('download', 'chase_transactions.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };
  </script>
</body>
</html>
