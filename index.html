<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üè¶ Chase Statement Analyser</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 1.5rem;
      max-width: 900px;
      margin: 0 auto;
      background-color: #fafafa;
      color: #333;
    }
    h1 { color: #1a5fb4; margin-bottom: 0.5rem; }
    .subtitle { color: #666; margin-top: 0; }
    input[type="file"] {
      margin: 1rem 0;
      font-size: 1rem;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      width: 100%;
      box-sizing: border-box;
    }
    progress {
      margin-top: 0.5rem;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      display: none;
    }
    .log {
      font-size: 0.85rem;
      color: #555;
      margin: 0.5rem 0;
      min-height: 1.2em;
    }
    #output {
      margin-top: 1.5rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }
    th, td {
      padding: 12px 14px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #1a5fb4;
    }
    tr.expense td:first-child { color: #d32f2f; }
    tr.income td:first-child { color: #2e7d32; }
    .summary {
      background: #f0f7ff;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1.5rem;
    }
    .summary h3 { margin-top: 0; color: #1a5fb4; }
    .summary p { margin: 0.3rem 0; }
    .btn {
      background: #1a5fb4;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 1rem;
    }
    .btn:hover { background: #144d96; }
    .debug-toggle {
      color: #1a73e8;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .debug {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 6px;
      margin-top: 1rem;
      white-space: pre-wrap;
      max-height: 200px;
      overflow: auto;
      font-family: monospace;
      font-size: 0.85rem;
    }
    footer {
      margin-top: 2rem;
      font-size: 0.8rem;
      color: #888;
      text-align: center;
    }
    .chart-wrapper {
      max-width: 480px;
      height: 320px;
      margin: 0 auto;
      position: relative;
    }
  </style>
</head>
<body>
  <h1>üè¶ Chase Statement Analyser</h1>
  <p class="subtitle">Upload your Chase PDF ‚Üí Get smart spend insights.</p>

  <input type="file" id="pdfUpload" accept=".pdf" />
  <progress id="progress" value="0" max="100"></progress>
  <div id="log" class="log">üëâ Choose a PDF to begin.</div>
  
  <div id="output"></div>

  <footer>
    <p>All processing happens in your browser ‚Äî no data leaves your device.</p>
  </footer>

  <script>
    // ‚úÖ 1. Categorisation (on-device, no API)
    function categoriseTransaction(description) {
      const desc = description.toLowerCase().trim();

      const rules = [
        { keywords: ['tesco', 'sainsbury', 'aldi', 'waitrose', 'co-op', 'coop', 'ocado', 'asda', 'lidl', 'morrisons'], category: 'Groceries' },
        { keywords: ['pret', 'costa', 'starbucks', 'greggs', 'mcdonald', 'burger king', 'nando', 'domino', 'deliveroo', 'just eat', 'ubereats', 'cafe', 'coffee'], category: 'Eating out' },
        { keywords: ['amazon', 'argos', 'boots', 'superdrug', 'whsmith', 'next', 'zara', 'asos', 'temu', 'shein', 'nyx', 'halfords', 'b&q', 'homebase'], category: 'Shopping' },
        { keywords: ['petrol', 'fuel', 'shell', 'esso', 'bp', 'trainline', 'gwr', 'thameslink', 'uber', 'bolt', 'taxi', 'bus'], category: 'Transport' },
        { keywords: ['pharmacy', 'boots', 'superdrug', 'dentist', 'barber', 'hair', 'massage', 'yuenique', 'manor dental'], category: 'Health & Personal' },
        { keywords: ['netflix', 'spotify', 'disney', 'prime', 'apple.com/bill', 'klarna', 'box.co.uk', 'fraser retail'], category: 'Subscriptions' },
        { keywords: ['chase saver', 'rewards', 'transfer'], category: 'Transfers' },
        { keywords: ['payment from', 'from tom', 'salary', 'wage', 'payroll'], category: 'Income' },
      ];

      for (const rule of rules) {
        if (rule.keywords.some(kw => desc.includes(kw))) {
          return rule.category;
        }
      }

      if (desc.includes('gym') || desc.includes('fitness') || desc.includes('sport') || desc.includes('homefitness')) return 'Sports & Health';
      if (desc.includes('charity') || desc.includes('donation')) return 'Giving';
      if (desc.includes('hotel') || desc.includes('booking') || desc.includes('airbnb')) return 'Travel';
      if (desc.includes('pharmacy') || desc.includes('medic')) return 'Health';
      if (desc.includes('bar') || desc.includes('pub') || desc.includes('club')) return 'Nightlife';

      return 'Other';
    }

    // ‚úÖ 2. Chase PDF Parser
    function parseChaseStatement(text) {
      let cleaned = text
        .replace(/\s+/g, ' ')
        .replace(/(\d{1,2} [A-Za-z]{3} \d{4})/g, '\n$1')
        .trim();

      const lines = cleaned.split('\n').map(l => l.trim()).filter(l => l.length > 25);

      const monthMap = {
        Jan: '01', Feb: '02', Mar: '03', Apr: '04', May: '05', Jun: '06',
        Jul: '07', Aug: '08', Sep: '09', Oct: '10', Nov: '11', Dec: '12'
      };

      const transactions = [];
      const transactionRegex = /(\d{1,2})\s+([A-Za-z]{3})\s+(\d{4})\s+(.*?)\s+(Purchase|Transfer|Refund|Payment)\s+([+-]¬£[\d,]*\.?\d+)\s+¬£[\d,]*\.?\d+/;

      for (const line of lines) {
        if (
          line.includes('Account number') ||
          line.includes('Sort code') ||
          line.includes('Thomas\' Account statement') ||
          line.includes('Opening balance') ||
          line.includes('Closing balance') ||
          line.includes('Page ') ||
          line.includes('FSCS') ||
          line.includes('From 1 December 2025') ||
          line.includes('The best way to call')
        ) continue;

        const match = line.match(transactionRegex);
        if (match) {
          const [_, day, monthAbbr, year, brand, typeWord, amountStr] = match;

          const month = monthMap[monthAbbr] || '01';
          const date = `${year}-${month}-${day.padStart(2, '0')}`;

          // üîë Handle all minus sign variants
          let cleanAmountStr = amountStr
            .replace(/[¬£,]/g, '')
            .replace(/‚àí|‚Äì|‚Äî/g, '-')  // en dash, em dash, minus ‚Üí ASCII '-'
            .trim();

          let amountNum = parseFloat(cleanAmountStr);
          if (isNaN(amountNum)) {
            console.warn('‚ö†Ô∏è Failed to parse amount:', amountStr);
            amountNum = 0;
          }

          let description = brand.trim();
          if (description.includes(' - ')) {
            const parts = description.split(' - ');
            description = parts[parts.length - 1].trim();
          }

          transactions.push({
            date,
            description,
            amount: Math.abs(amountNum),
            type: amountNum < 0 ? 'expense' : 'income',
            category: ''
          });
        }
      }

      return transactions;
    }

    // ‚úÖ 3. Render spending pie chart (FULLY FIXED)
    let categoryChartInstance = null;

    function renderCategoryChart(categoryTotals, canvasEl) {
      // Expect a canvas element in the DOM; bail if missing
      if (!canvasEl) return;

      // Stabilise size to prevent layout jitter
      canvasEl.width = 480;
      canvasEl.height = 320;
      const ctx = canvasEl.getContext('2d');

      if (categoryChartInstance) {
        categoryChartInstance.destroy();
      }

      const entries = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);
      const top5 = entries.slice(0, 5);
      const other = entries.slice(5).reduce((sum, [, amt]) => sum + amt, 0);
      
      const labels = top5.map(([cat]) => cat);
      const data = top5.map(([, amt]) => amt);
      const colors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
        '#FF9F40', '#C9CBCF', '#4B9F71', '#8E5EA2', '#329F8C'
      ];

      if (other > 0) {
        labels.push('Other');
        data.push(other);
      }

        // ‚úÖ Critical: '' key WITH colon, no missing punctuation
      categoryChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderWidth: 0
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: (ctx) => `¬£${ctx.raw.toFixed(2)}`
              }
            }
          },
          responsive: false,
          maintainAspectRatio: false
        }
      });
    }

    // ‚úÖ 4. Generate smart insights (UK-accurate)
    function generateInsights(transactions) {
      const expenses = transactions.filter(t => t.type === 'expense');
      if (expenses.length === 0) return '';

      const insights = [];

      // Coffee spend
      const coffeeTransactions = expenses.filter(t => 
        t.category === 'Eating out' && 
        /pret|costa|starbucks|coffee|cafe/i.test(t.description)
      );
      const coffeeSpend = coffeeTransactions.reduce((sum, t) => sum + t.amount, 0);
      if (coffeeSpend > 0) {
        const avgUK = 28.50;
        const ratio = Math.round(coffeeSpend / avgUK * 10) / 10;
        insights.push(`‚òï You spent ¬£${coffeeSpend.toFixed(2)} on coffee this month ‚Äî ${ratio}√ó the UK average!`);
      }

      // Grocery efficiency
      const groceryExpenses = expenses.filter(t => t.category === 'Groceries');
      const grocerySpend = groceryExpenses.reduce((sum, t) => sum + t.amount, 0);
      const groceryVisits = groceryExpenses.length;
      if (groceryVisits > 0) {
        const avgSpendPerTrip = grocerySpend / groceryVisits;
        if (avgSpendPerTrip > 35) {
          insights.push(`üõí Average grocery trip: ¬£${avgSpendPerTrip.toFixed(2)} ‚Äî try smaller, more frequent shops to reduce impulse buys.`);
        } else if (avgSpendPerTrip < 15) {
          insights.push(`üõí Excellent! You spent just ¬£${avgSpendPerTrip.toFixed(2)} per grocery trip.`);
        }
      }

      // Subscriptions
      const subs = expenses.filter(t => t.category === 'Subscriptions');
      const subSpend = subs.reduce((sum, t) => sum + t.amount, 0);
      if (subSpend > 30) {
        insights.push(`üì± You spent ¬£${subSpend.toFixed(2)} on subscriptions ‚Äî review unused ones.`);
      }

      // Largest spend
      if (expenses.length > 0) {
        const largest = expenses.reduce((max, t) => t.amount > max.amount ? t : max);
        if (largest.amount > 50) {
          insights.push(`‚ö†Ô∏è Largest single expense: ¬£${largest.amount.toFixed(2)} at ${largest.description}`);
        }
      }

      // Transfers
      const transfers = transactions.filter(t => t.category === 'Transfers').length;
      if (transfers > 0) {
        insights.push(`üîÅ ${transfers} internal transfers detected ‚Äî these don‚Äôt affect real spending.`);
      }

      // ‚úÖ FSCS Protection ‚Äî accurate per fscs.org.uk
      insights.push(`üõ°Ô∏è Your Chase UK deposits are protected by the FSCS up to ¬£120,000 from 1 December 2025 (currently ¬£85,000).`);

      return insights.length > 0 
        ? `<div class="summary"><h3>üí° Smart Insights</h3>${insights.map(i => `<p>${i}</p>`).join('')}</div>`
        : '';
    }

    // ‚úÖ 5. CSV Download
    window.downloadCSV = function(transactions) {
      const header = 'Date,Description,Category,Amount,Type\n';
      const rows = transactions.map(t => {
        const [year, month, day] = t.date.split('-');
        const ukDate = `${day}/${month}/${year}`;
        return `"${ukDate}","${t.description.replace(/"/g, '""')}","${t.category}","${t.amount}","${t.type}"`;
      }).join('\n');
      const csvContent = 'text/csv;charset=utf-8,' + encodeURIComponent(header + rows);
      
      const link = document.createElement('a');
      link.setAttribute('href', csvContent);
      link.setAttribute('download', 'chase_spending_analysis.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    // ‚úÖ 6. PDF Upload Handler
    document.getElementById('pdfUpload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const output = document.getElementById('output');
      const log = document.getElementById('log');
      const progress = document.getElementById('progress');

      output.innerHTML = '';
      log.textContent = `‚úÖ File selected: ${file.name}`;
      progress.style.display = 'block';
      progress.value = 10;

      if (!file.name.toLowerCase().endsWith('.pdf')) {
        log.textContent = '‚ö†Ô∏è Please upload a .pdf file.';
        progress.style.display = 'none';
        return;
      }

      log.textContent = 'üì¶ Reading file...';

      try {
        const reader = new FileReader();
        reader.onload = async function() {
          const typedarray = new Uint8Array(reader.result);

          log.textContent = 'üì• Loading pdf.js (one-time, ~500 KB)...';
          const pdfjs = await import('https://unpkg.com/pdfjs-dist@4.4.168/build/pdf.min.mjs');
          pdfjs.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@4.4.168/build/pdf.worker.min.mjs';

          log.textContent = 'üìÑ Parsing PDF pages...';
          progress.value = 30;

          const loadingTask = pdfjs.getDocument(typedarray);
          loadingTask.onProgress = ({ loaded, total }) => {
            progress.value = 30 + (loaded / total) * 60;
          };

          const pdf = await loadingTask.promise;
          log.textContent = `‚úÖ Loaded ${pdf.numPages} page(s). Extracting text...`;

          let fullText = '';
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join(' ');
            fullText += pageText + ' ';
          }

          log.textContent = 'üîç Parsing transactions...';
          let transactions = parseChaseStatement(fullText);

          // Add categories
          transactions.forEach(t => {
            t.category = categoriseTransaction(t.description);
          });

          if (transactions.length === 0) {
            const snippet = fullText.substring(0, 800).replace(/\n/g, ' ‚Üµ ');
            output.innerHTML = `
              <div style="padding:1.5rem; background:#fff9f9; border-left:4px solid #d32f2f;">
                <h3>‚ö†Ô∏è No transactions found</h3>
                <p>We tried to parse your Chase statement, but couldn‚Äôt match any lines.</p>
                <p><strong>Try:</strong> Exporting a fresh statement from the Chase app (PDF, not image).</p>
                <p class="debug-toggle" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                  üîç Show first 800 chars (click to toggle)
                </p>
                <div class="debug" style="display:none;">${snippet}</div>
              </div>
            `;
          } else {
            const expenses = transactions.filter(t => t.type === 'expense');
            const income = transactions.filter(t => t.type === 'income');

            const totalExpenses = expenses.reduce((sum, t) => sum + t.amount, 0);
            const totalIncome = income.reduce((sum, t) => sum + t.amount, 0);
            const net = totalIncome - totalExpenses;

            // Category totals (only for expenses)
            const categoryTotals = {};
            expenses.forEach(t => {
              const cat = t.category;
              categoryTotals[cat] = (categoryTotals[cat] || 0) + t.amount;
            });

            // üìà Chart markup placeholder (render after injecting HTML)
            let chartSection = '';
            if (Object.keys(categoryTotals).length > 0) {
              chartSection = `
                <div class="summary" style="display:flex; flex-direction:column; gap:0.75rem;">
                  <h3>üç© Spending Breakdown</h3>
                  <div class="chart-wrapper">
                    <canvas id="categoryChart" aria-label="Spending by category" role="img"></canvas>
                  </div>
                </div>
              `;
            }

            // üí° Insights
            const insightsHtml = generateInsights(transactions);

            // Summary
            let summary = `
              <div class="summary">
                <h3>üìä Monthly Summary</h3>
                <p><strong>Expenses:</strong> ‚àí¬£${totalExpenses.toFixed(2)}</p>
                <p><strong>Income:</strong> +¬£${totalIncome.toFixed(2)}</p>
                <p><strong>Net change:</strong> <span style="color:${net >= 0 ? '#2e7d32' : '#d32f2f'}">${net >= 0 ? '+' : ''}¬£${net.toFixed(2)}</span></p>
                <p><strong>Total transactions:</strong> ${transactions.length}</p>
              </div>
            `;

            // Top categories
            const topCategories = Object.entries(categoryTotals)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 3);
            let categoryInsight = `<div class="summary"><h3>üõí Top Spending Categories</h3>`;
            topCategories.forEach(([cat, amt]) => {
              categoryInsight += `<p><strong>${cat}:</strong> ¬£${amt.toFixed(2)}</p>`;
            });
            if (topCategories.length === 0) {
              categoryInsight += `<p>No spending detected ‚Äî all transactions were income/transfers.</p>`;
            }
            categoryInsight += `</div>`;

            // Build table ‚Äî ‚úÖ FIXED SIGN
            let rows = '';
            transactions.forEach(t => {
              const cls = t.type === 'expense' ? 'expense' : 'income';
              const sign = t.type === 'expense' ? '-' : '+';  // ASCII hyphen

              const [year, month, day] = t.date.split('-');
              const ukDate = `${day}/${month}/${year}`;

              rows += `
                <tr class="${cls}">
                  <td>${ukDate}</td>
                  <td>${t.description}</td>
                  <td>${t.category}</td>
                  <td>${sign}¬£${t.amount.toFixed(2)}</td>
                </tr>
              `;
            });

            const table = `
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Amount</th>
                  </tr>
                </thead>
                <tbody>
                  ${rows}
                </tbody>
              </table>
            `;

            output.innerHTML = chartSection + summary + categoryInsight + insightsHtml + table + `
              <button class="btn" onclick="downloadCSV(${JSON.stringify(transactions).replace(/'/g, "\\'")})">
                ‚¨áÔ∏è Download Full Analysis (CSV)
              </button>
            `;

            // Render chart once the canvas exists in the DOM
            if (Object.keys(categoryTotals).length > 0) {
              const canvasEl = document.getElementById('categoryChart');
              renderCategoryChart(categoryTotals, canvasEl);
            }
          }

          progress.style.display = 'none';
          log.textContent = `üéâ Done! ${transactions.length} transactions analysed.`;
        };

        reader.onerror = () => {
          log.textContent = '‚ùå Failed to read file.';
          progress.style.display = 'none';
        };

        reader.readAsArrayBuffer(file);
      } catch (error) {
        log.textContent = `üí• Error: ${error.message}`;
        output.innerHTML = `<pre style="padding:1rem; background:#ffebee; color:#c62828;">${error.stack || error}</pre>`;
        progress.style.display = 'none';
        console.error(error);
      }
    })
  </script>
</body>
</html>
